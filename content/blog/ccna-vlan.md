---
title: CCNA-VLAN
date: 2010-11-04
author: admin
category: network
tags: ccna, cisco, vlan
slug: ccna-vlan
---

-   虚拟局域网（virtual lan，vlan）
    -   优点
    -   vlan id范围
    -   vlan 类型
    -   vlan中继
-   vlan 中继协议（vlan trunk protocol）
    -   基本概念
    -   操作过程
    -   配置和排错
-   vlan间路由
    -   每接口对应一个vlan
    -   单臂路由（router on  a stick）
-   配置语音vlan

虚拟局域网（vlan）
------------------

### 优点

虚拟局域网相对传统局域网的优点有如下几条：

1.  安全，实现了数据隔离
2.  成本降低
3.  性能提高
4.  广播控制
5.  简化应用管理和项目管理

### vlan id范围

  ---------- ---------------------------------------------------- --------------------
  名称       普通vlan（normal）                                   扩展vlan（extend）
  ID范围     1-1005（其中1和1002-1005自动创建不能删除不能修改）   1006-4094
  保存位置   Flash中的vlan.dat数据库文件中                        运行配置文件中
  VTP支持    支持                                                 不支持（v3支持）
  ---------- ---------------------------------------------------- --------------------

### vlan 类型

  -------------------- -----------------------------------------
  名称                 介绍
  数据vlan             传送用户数据
  默认vlan             所有接口默认所属vlan，指vlan1
  黑洞vlan             也叫哑vlan，未使用端口分配的vlan
  本征（native）vlan   中继端口所属的vlan
  管理vlan             用于访问交换机管理功能的vlan，默认vlan1
  语音vlan             用于传送语音的vlan，需要专门配置
  -------------------- -----------------------------------------

### vlan 中继

vlan中继用于分配在不同交换机上相同vlan的主机间相互通信，有两种中继协议，ISL和802.1q。ISL（inter-switch
link）协议时再以太网帧的基础上加上26字节的报头和4字节的FCS，基本不太常用。主要介绍802.1q协议，帧格式如下：

  ----------- --------- --------------------------- ---------------- --------------- --------------- ------------ ------ --------- -------
  目的地址6   源地址6   Ethertype=0x8100协议标识2   用户优先级3bit   CFI令牌网1bit   vlan-id 12bit   长度/类型2   数据   pad填充   FCS 4
  ----------- --------- --------------------------- ---------------- --------------- --------------- ------------ ------ --------- -------

其中，用户优先级用于服务质量，而vlan-id用来标识不同vlan的数据。还要强调的是本征vlan，实际上它就是一个特殊的vlan，只有中继链路的两个接口划分到这个vlan。当交换机将不同vlan的数据发送到其他交换机的时候再中继链路的出口上打上相应的标签，通过中继链路传到其他交换机上时其他交换机根据根据标签转发数据，在转发到相应访问接口时会去掉相应的标签，也就是说只在中继链路上才能看到打了标签的帧。本征vlan另一个作用就是如果再中继端口上收到没有打标签的帧则发送给本征vlan，这样就能保证像CDP的协议正常工作。

vlan中继协议（vlan trunk protocol）
-----------------------------------

vtp是要完成在所有的交换机上实现vlan的统一管理的任务。vtp要工作在一个vtp域中，两个不同域的交换机不能相互传递vlan信息，拥有共同域名的交换机构成一个vtp域

### 基本概念

vtp消息封装于以太网帧（目的地址使用组播地址0100-0ccc-cccc）中，然后打上标签通过中继链路上传播vlan信息

#### 服务器server

这是catalyst交换机的默认模式，负责管理整个vtp域内的所有vlan信息，包括添加删除和修改。而且要注意服务器模式下的交换机vlan信息保存于NVRAM中

#### 客户端client

只能接收服务器发来的vlan信息并更新自己的vlan信息，转发更新，但不能删除和修改vlan

#### 透明transparent

接收并转发vtp通告，但不会更新自己的vlan数据库，也不会把自己的vlan信息发送给其他交换机，仅能管理本地的vlan数据库。

#### vtp修剪

达到仅将广播信息发送到需要该信息的中继链路上的目的

### 操作过程

交换机的默认配置如下：

  -------------- --------
  名称           值
  vtp版本        1
  vtp域名        null
  vtp模式        server
  配置修订版本   0
  vlan           vlan1
  -------------- --------

#### vtp通告

总结通告

包括vtp配置的详细信息，由vtp服务器每5分钟发送一次，执行对vlan数据库配置后立即发送总结通告

子集通告

通告vlan具体信息

请求通告

请求vlan信息

注意：在以上几种通告中要注意配置修订版本号，它的值越大说明vlan信息越新,客户端通过比较配置修订版本号来决定是否更新本地vlan信息

### 配置和排错

#### 配置

-   \#vtp mode server | transparent | client
-   \#vtp domain name domain-name
-   \#vtp pruning

#### 排错

版本不兼容，域名不一致，没有启用vtp server

vlan间路由
----------

### 每接口对应一个vlan

每个vlan中的一个接入端口与路由器接口相连，对路由器屏蔽了vlan的概念，在路由器看来就是在路由两个不同网段

### 单臂路由（router on a stick）

通过配置中继和路由子接口，让路由器也参与到虚拟局域网中来，每个子接口对应于一个vlan接入接口，配置如下：

-   \#intface f0/0.1
-   \#encapsulation dot1q vlan 30
-   \#ip addr xxx xxxx

配置语音vlan
------------

ip电话就是一个特殊三端口的交换机，一个口接交换机的接入端口，一个接pc，另一个供自身使用，它和交换机建立中继链路（通过CDP）以承载pc发来的流量。需要注意的是这里交换机端口不再仅属于一个vlan，出了接入vlan外还要在其开启服务质量后分配一个语音vlan以承载语音数据。配置具体步骤如下

-   \#config t 进入全局配置模式
-   \#mls qos 开启服务质量
-   \#interface f/1 进入端口配置模式
-   \#switchport priority extend trust
-   \#mls qos trust cos
-   \#switchport voicevlan dot1q
-   \#switchport mode access
-   \#switchport access vlan 3
-   \#switchport   voice vlan 10

