---
title: Ping命令的工作过程及单向Ping通的原因
date: 2010-06-06
author: admin
category: protocol
tags: ping
slug: ping命令的工作过程及单向ping通的原因
---

当网络出现问题时，我们最常用的测试工具就是“Ping”命令了。但有时候我们会碰到单方向Ping通的现象，例如通过HUB或一根交叉线连接的在同一个
局域网内的电脑A、 B，在检查它们之间的网络连通性时，发现从主机A Ping
主机B正常而从主机B Ping 主机A时，出现“超时无应答”错误。为什么呢?  
要知道这其中的奥秘，我们有必要来看看Ping命令的工作过程到底是怎么样的。

原理部分：

假定主机A的IP地址是192.168.1.1，主机B的IP地址是192.168.1.2，都在同一子网内，则当你在主机A上运行“Ping
192.168.1.2”后，都发生了些什么呢?

首先，Ping命令会构建一个固定格式的ICMP请求数据包，然后由ICMP协议将这个数据包连同地址“192.168.1.2”一起交给IP层协议（和
ICMP一样，实际上是一组后台运行的进程），IP层协议将以地址“192.168.1.2”作为目的地址，本机IP地址作为源地址，加上一些其他的控制
信息，构建一个IP数据包，并在一个映射表中查找出IP地址192.168.1.2所对应的物理地址（也叫MAC地址，熟悉网卡配置的朋友不会陌生，这是
数据链路层协议构建数据链路层的传输单元——帧所必需的），一并交给数据链路层。后者构建一个数据帧，目的地址是IP层传过来的物理地址，源地址则是本机
的物理地址，还要附加上一些控制信息，依据以太网的介质访问规则，将它们传送出去。

主机B收到这个数据帧后，先检查它的目的地址，并和本机的物理地址对比，如符合，则接收；否则丢弃。接收后检查该数据帧，将IP数据包从帧中提取出来，交
给本机的IP层协议。同样，IP层检查后，将有用的信息提取后交给ICMP协议，后者处理后，马上构建一个ICMP应答包，发送给主机A，其过程和主机A
发送ICMP请求包到主机B一模一样。

单向Ping通问题：

从Ping的工作过程，我们可以知道，主机A收到了主机B的一个应答包，说明两台主机之间的去、回通路均正常。也就是说，无论从主机A到主机B，还是从主机B到主机A，都是正常的。那么，是什么原因引起只能单方向Ping通的呢?

一、安装了个人防火墙

在共享上网的机器中，出于安全考虑，大部分作为服务器的主机都安装了个人防火墙软件，而其他作为客户机的机器则一般不安装。几乎所有的个人防火墙软件，默
认情况下是不允许其他机器Ping本机的。一般的做法是将来自外部的ICMP请求报文滤掉，但它却对本机出去的ICMP请求报文，以及来自外部的ICMP
应答报文不加任何限制。这样，从本机Ping其他机器时，如果网络正常，就没有问题。但如果从其他机器Ping这台机器，即使网络一切正常，也会出现“超
时无应答”的错误。

大部分的单方向Ping通现象源于此。解决的办法也很简单，根据你自己所用的不同类型的防火墙，调整相应的设置即可。

二、错误设置IP地址

正常情况下，一台主机应该有一个网卡，一个IP地址，或多个网卡，多个IP地址（这些地址一定要处于不同的IP子网）。但对于在公共场所使用的电脑，特别
是网吧，人多手杂，其中不泛有“探索者”。曾有一次两台电脑也出现了这种单方向Ping通的情况，经过仔细检查，发现其中一台电脑的“拨号网络适配器
”（相当于一块软网卡）的TCP/IP设置中，设置了一个与网卡IP地址处于同一子网的IP地址，这样，在IP层协议看来，这台主机就有两个不同的接口处
于同一网段内。当从这台主机Ping其他的机器时，会存在这样的问题：

（1）主机不知道将数据包发到哪个网络接口，因为有两个网络接口都连接在同一网段；

（2）主机不知道用哪个地址作为数据包的源地址。因此，从这台主机去Ping其他机器，IP层协议会无法处理，超时后，Ping
就会给出一个“超时无应答”的错误信息提示。但从其他主机Ping这台主机时，请求包从特定的网卡来，ICMP只须简单地将目的、源地址互换，并更改一些
标志即可，ICMP应答包能顺利发出，其他主机也就能成功Ping通这台机器了。
